---
title: "STAT 413/613: HW on List Columns and  COVID19"
author: "Jaehee Lee"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
    theme: cerulean
  pdf_document:
    toc: yes
    number_sections: yes
    toc_depth: '4'
params:
  solutions: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align  = "center",
                      fig.height = 5, 
                      fig.width  = 6)
```

# Instructions {-}
1. Clone this homework repo to your homework directory as a new repo.
2. Rename the starter file under the analysis directory as `hw_01_yourname.Rmd` and use it for your solutions.   
3. Modify the "author" field in the YAML header.  
4. Stage and Commit R Markdown and HTML files (no PDF files).   
5. **Push both .Rmd and HTML files to GitHub**.   
- Make sure you have knitted to HTML prior to staging, committing, and pushing your final submission.  
6. **Commit each time you answer a part of question, e.g. 1.1**   
7. **Push to GitHub after each major question**   
8. When complete, submit a response in Canvas   
    
- Only include necessary code to answer the questions.
- Most of the functions you use should be from the tidyverse. Unnecessary Base R or other packages not covered in class will result in point deductions.
- Use Pull requests and or email to ask me any questions. If you email, please ensure your most recent code is pushed to GitHub.  

- **Learning Outcome**
  + Use tidyverse functions to create, clean, tidy, and manipulate data frames in a list column
  + Apply purrr functions when working with list columns
  + Employ joins to manipulate data from multiple data frames  

- **Context** 
  + This assignment looks at COVID-19 data based on the most recent data as of the date you do the work.

Load library
```{r}
library(tidyverse)
```


# Load global and US confirmed cases and deaths data into a nested data frame
1. Create a variable called `url_in` to store this URL: "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/". This allows you do directly download the files at the John's Hopkins site:  "https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series"
```{r}
url_in <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/"
```

2. Create a tibble named `df` with a variable called `file_names` with a row for each of the following four file names to be loaded from the URL:
    + time_series_covid19_confirmed_global.csv
    + time_series_covid19_deaths_global.csv
    + time_series_covid19_confirmed_US.csv
    + time_series_covid19_deaths_US.csv
```{r}
df <- tibble(
 file_names = 
   c('time_series_covid19_confirmed_global.csv', 
  'time_series_covid19_deaths_global.csv',
  'time_series_covid19_confirmed_US.csv',
  'time_series_covid19_deaths_US.csv')
)
```

3. Create a variable in the data frame called `url` that puts `url_in` on the front of each file_name to create a complete URL.
```{r}
df %>%  
  mutate(url = str_c(url_in, file_names, sep = '')) -> df
```

4. Use `mutate()` with `map()` to create a list column called `data` with each row holding the downloaded data frame for each file name

```{r}
df %>%
  mutate(data = map(url, read_csv)) -> df
```
5. Add a factor variable to `df` called `"`case_type`"` with the **unique** portions of the file names.
```{r}
df %>%  
  mutate(case_types = as_factor(str_extract(file_names,"[:alpha:]*_[gU][:alpha:]*"))) -> df
```
6. Remove any columns other than `case_types` and `data` from `df`.
- `df` should have four observations of two variables.
```{r}
df %>%  
  select("case_types", "data" ) -> df
```

# Clean Data  
1. Using a single call to `map()`, add only the first 15 names from each of the four data frames to a new variable in `df` called `vars`.
 - Visually compare them to identify issues across the rows.
```{r}
df %>%  
  mutate(vars = map(df$data, names)) -> df
df %>% 
  mutate(vars = map(df$vars, ~unlist(.)[1:15]))
```
2. Use a purrr function for each of the following steps (except a) to fix any issues and create consistent data frames.  
a. Create a short helper function called `fix_names()` which takes three arguments: a data frame, a string pattern, and a string "replacement pattern". It should replace all occurrences of the "string pattern" in the names of the variables in the data frame with the "replacement pattern". Include error checking to ensure the inputs are of the proper class.
```{r}
fix_names <- function(dataframe, string_pattern, replacement_pattern) {
  stopifnot(is.data.frame(dataframe))
  stopifnot(is.character(string_pattern))
  stopifnot(is.character(replacement_pattern))
  
  names(dataframe) = str_replace_all(names(dataframe), string_pattern, replacement_pattern)
  
  return(dataframe)
}
```

b. Use your function with `map()` to convert "Province/State" and "Country/Region" to "Province_State" "Country_Region" .
```{r}
df %>%  
  mutate(data = map(data, ~fix_names(. , "([ey])/", "\\1_"))) -> df
```


c. Use your function with `map()` to convert "Admin2 to "County" and "Long_" to "Long".
```{r}
df %>%  
  mutate(data = map(data, ~fix_names(. , "Admin2", "County" ))) %>%  
  mutate(data = map(data, ~fix_names(. , "Long_", "Long") ))-> df
```

d. Use a purrr function to remove the variables "UID", "iso2", "iso3", "code3", "FIPS", and "Combined_Key" from only the US data.
```{r}
df %>%  
  mutate(data = map_if(data, str_detect(df$case_types, "_US"), ~select(.,-c("UID", "iso2", "iso3", "code3", "FIPS", "Combined_Key")))) -> df
```

e. Use a purrr function to add variables `Population` and `County` to the data frames where missing.
```{r}
map_if(df$data, ~!'Population'%in% colnames(.), ~mutate(. ,Population = 1 )) -> df$data
map_if(df$data, ~!'County'%in% colnames(.), ~mutate(. ,County = 1 )) -> df$data

```
 

